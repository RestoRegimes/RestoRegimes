{# src/OC/PlatformBundle/Resources/views/Advert/form.html.twig #}

{# Cette vue n'hérite de personne, elle sera incluse par d'autres vues qui,
   elles, hériteront probablement du layout. Je dis « probablement » car,
   ici pour cette vue, on n'en sait rien et c'est une info qui ne nous concerne pas. #}

<h3>Formulaire restaurant</h3>

{# On laisse vide la vue pour l'instant, on la comblera plus tard
   lorsqu'on saura afficher un formulaire. #}
<div class="well">
  {{ form(form) }}
</div>

{# src/OC/PlatformBundle/Resources/views/Advert/form.html.twig #}

{# On charge la bibliothèque jQuery. Ici, je la prends depuis le CDN google
   mais si vous l'avez en local, changez simplement l'adresse. #}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

{# Voici le script en question : #}
<script type="text/javascript">
   $(document).ready(function() {
      // On récupère la balise <div> en question qui contient l'attribut « data-prototype » qui nous intéresse.
      var $container = $('div#rr_restaurantbundle_restaurant_images');

      // On ajoute un lien pour ajouter une nouvelle catégorie
      var $addLink = $('<a href="#" id="add_image" class="btn btn-default">Ajouter une image</a>');
      $container.append($addLink);

      // On ajoute un nouveau champ à chaque clic sur le lien d'ajout.
      $addLink.click(function(e) {
         addImage($container);
         e.preventDefault(); // évite qu'un # apparaisse dans l'URL
         return false;
      });

      // On définit un compteur unique pour nommer les champs qu'on va ajouter dynamiquement
      var index = $container.find(':input').length;

      // On ajoute un premier champ automatiquement s'il n'en existe pas déjà un (cas d'une nouvelle annonce par exemple).


      // La fonction qui ajoute un formulaire Categorie
      function addImage($container) {
         if(index>=5)return;
         // Dans le contenu de l'attribut « data-prototype », on remplace :
         // - le texte "__name__label__" qu'il contient par le label du champ
         // - le texte "__name__" qu'il contient par le numéro du champ
         var $prototype = $($container.attr('data-prototype').replace(/__name__label__/g, 'Image n°' + (index+1))
                 .replace(/__name__/g, index));

         // On ajoute au prototype un lien pour pouvoir supprimer la catégorie
         addDeleteLink($prototype);

         // On ajoute le prototype modifié à la fin de la balise <div>
         $container.append($prototype);

         // Enfin, on incrémente le compteur pour que le prochain ajout se fasse avec un autre numéro
         index++;
      }

      // La fonction qui ajoute un lien de suppression d'une catégorie
      function addDeleteLink($prototype) {
         // Création du lien
         $deleteLink = $('<a href="#" class="btn btn-danger">Supprimer</a>');

         // Ajout du lien
         $prototype.append($deleteLink);

         // Ajout du listener sur le clic du lien
         $deleteLink.click(function(e) {
            $prototype.remove();
            e.preventDefault(); // évite qu'un # apparaisse dans l'URL
            index--;
            return false;
         });
      }
   });
</script>

